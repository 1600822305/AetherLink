# Context
File name: task_news_summary_optimization.md
Created: [Date Time]
Creator: AI
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol (Conditional Interactive Step Review Enhanced)

# Task Description
用户反馈新闻摘要显示效果不佳（只显示标题，格式奇怪，部分内容乱码），并且需要手动刷新页面才能看到结果。新增需求：新闻标题需要可以点击跳转，并且条目有类似引用的上标数字效果。最新反馈：整体显示效果仍不符合期望，AI按自己想法优化。**最新进展：发现前端将HTML标签直接显示为文本，需要退回到纯文本格式化方案。**目标是优化新闻摘要的内容展示、解决乱码问题、解决UI刷新问题，并使用纯文本字符实现美观的格式化效果。

# Project Overview
AI辅助的Web搜索和信息处理应用。

---
*The following sections are maintained by AI during protocol execution*
---

# Analysis (Filled by RESEARCH mode)
- `NewsSummaryGenerator.ts` 中的 `extractNewsInfo` 函数将新闻内容摘要硬编码为空字符串（已修改为提取snippet）。
- `generateNewsSummary` 和 `generateDetailedNewsSummary` 仅使用标题（和来源），缺乏实际内容（已修改为包含snippet）。
- `WebSearchBackendService.ts` 中的状态更新逻辑可能导致UI刷新延迟（已进行初步优化）。
- 新闻摘要中的 `snippet` 内容在显示时出现乱码，怀疑是字符编码问题或HTML实体未正确解码（已添加日志和HTML解码尝试）。
- 当前摘要为纯文本，无法点击标题，也无上标数字（已尝试修改为生成包含`<a>`和`<sup>`的HTML）。
- 前端已尝试渲染HTML，但默认样式和结构可能不佳（已尝试优化HTML结构以方便前端CSS定制）。
- **新增：发现前端UI将HTML标签作为纯文本显示，无法正确渲染HTML。需要改变策略，使用纯文本字符来实现格式化。**

# Proposed Solutions (Filled by INNOVATE mode)
1.  **改进新闻摘要内容显示**: 修改 `extractNewsInfo` 恢复从 `result.snippet` 提取内容，并进行清理和截断。相应更新两个摘要生成函数以显示内容（已完成）。
2.  **解决UI刷新问题**: 细化 `WebSearchBackendService.ts` 中新闻处理路径的状态更新，确保在关键步骤及时更新UI，并在生成新闻前明确提示"正在生成摘要"（已完成初步调整）。
3.  **诊断和修复乱码问题**：
    *   在 `extractNewsInfo` 中记录原始 `snippet` 以判断乱码源头（已添加）。
    *   尝试对 `snippet` 进行HTML实体解码（已添加）。
4.  **实现可点击链接和上标效果**：
    *   修改 `extractNewsInfo` 确保返回 `url`（已完成）。
    *   修改摘要生成函数，使用HTML `<a>` 标签包装标题以实现链接，使用 `<sup>` 标签实现上标数字（已完成，但前端无法渲染）。
5.  **优化生成的HTML结构**：
    *   为引言、分类标题、新闻列表、单个新闻条目等元素添加HTML包裹标签（如`<p>`, `<h3>`, `<div>`）和CSS类名（已完成，但前端无法渲染）。
6.  **新增：退回到纯文本格式化方案**：
    *   移除所有HTML标签，使用Unicode字符、空格和换行符创建视觉格式。
    *   使用特殊字符前缀（如 ▶, •）表示标题和列表项。
    *   使用 [标题](URL) 格式显示链接（虽然不可点击，但用户可以看到URL）。

# Implementation Plan (Generated by PLAN mode)
Implementation Checklist:
1. [创建任务文件 `task_news_summary_optimization.md`, review:false] (已完成)
2. [修改 `src/shared/utils/NewsSummaryGenerator.ts`中的 `extractNewsInfo` 函数，以提取和清理 `result.snippet` 作为内容摘要, review:true] (已完成)
3. [修改 `src/shared/utils/NewsSummaryGenerator.ts`中的 `generateNewsSummary` 函数，以在摘要中包含提取的内容摘要, review:true] (已完成)
4. [修改 `src/shared/utils/NewsSummaryGenerator.ts`中的 `generateDetailedNewsSummary` 函数，以在摘要中包含提取的内容摘要, review:true] (已完成)
5. [修改 `src/shared/services/WebSearchBackendService.ts` 中的 `processSearchAndSendToAI` 函数，在新闻处理分支中，优化状态更新调用逻辑, review:true] (已完成)
6. [在 `src/shared/utils/NewsSummaryGenerator.ts` 的 `extractNewsInfo` 函数中，添加 `console.log` 来记录原始 `result.snippet` 的值, review:true] (已完成)
7. [在 `src/shared/utils/NewsSummaryGenerator.ts` 的 `extractNewsInfo` 函数中，在处理 `snippet` 的开头，尝试使用DOM方法进行HTML实体解码, review:true] (已完成)
8. [修改 `src/shared/utils/NewsSummaryGenerator.ts` 的 `extractNewsInfo` 函数，确保返回 `url`, review:true] (已完成)
9. [修改 `src/shared/utils/NewsSummaryGenerator.ts` 的 `generateNewsSummary` 函数，实现新闻标题的可点击链接和上标数字格式, review:true] (已完成)
10. [修改 `src/shared/utils/NewsSummaryGenerator.ts` 的 `generateDetailedNewsSummary` 函数，实现新闻标题的可点击链接和上标数字格式, review:true] (已完成)
11. [修改 `src/shared/utils/NewsSummaryGenerator.ts` 的 `generateNewsSummary` 函数，以实现新的、更结构化的HTML输出 (使用 `<p>`, `<h3>`, `<div>`, `<strong>`, `<br />` 和 CSS 类名), review:true] (已完成)
12. [修改 `src/shared/utils/NewsSummaryGenerator.ts` 的 `generateDetailedNewsSummary` 函数，以实现新的、更结构化的HTML输出 (使用 `<p>`, `<h3>`, `<div>`, `<strong>`, `<br />` 和 CSS 类名), review:true] (已完成)
13. [**新** 修改 `src/shared/utils/NewsSummaryGenerator.ts` 的 `generateNewsSummary` 函数，移除HTML标签，实现纯文本格式化, review:true]
14. [**新** 修改 `src/shared/utils/NewsSummaryGenerator.ts` 的 `generateDetailedNewsSummary` 函数，移除HTML标签，实现纯文本格式化, review:true]

# Current Execution Step (Updated by EXECUTE mode when starting execution of a step)
> Executing: "[Step number and name]" (Review requirement: [review:true/false], Status: [e.g., preliminary implementation / interactive review / awaiting direct confirmation / awaiting final confirmation])

# Task Progress (Appended by EXECUTE mode after each step completion and during interactive review iterations)
*   [Date Time]
    *   Step: [Checklist item number and description (Review requirement: review:true/false, Status: e.g., preliminary completion / user sub-prompt iteration / interactive review ended / direct confirmation / user final confirmation)]
    *   Modifications: [List of files and code changes, including minor deviation corrections, all interactive review iteration modification details, or generated text answers]
    *   Change Summary: [Brief description of this change, iteration, or key points of generated answers]
    *   Reason: [Execute plan step [X] / Handle user sub-prompt / Complete interactive review of step [X] / Request direct confirmation]
    *   Obstacles: [Any problems encountered, or none]
    *   User Confirmation Status: [Final status for this step: pending confirmation / success / success but with minor issues / failure]
    *   (If applicable) Interactive Review Script Exit Information: [Script exit reason or message / not applicable]

# Final Review (Filled by REVIEW mode)
[Comprehensive compliance assessment summary of all task step results, whether any unreported deviations not conforming to the final confirmed plan were found] 