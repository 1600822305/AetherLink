# 移动端话题管理优化方案

本方案旨在优化移动端的话题管理实现，使其更接近电脑版的实现方式，简化代码结构，提高性能和可维护性。

## 问题分析

当前移动端实现存在以下问题：

1. **复杂的事件处理机制**：使用多种事件通知方式（自定义DOM事件、Redux状态更新、本地状态）导致逻辑分散
2. **冗余的状态管理**：同时维护Redux状态和组件本地状态，容易导致不一致
3. **DexieStorageService过于复杂**：包含大量错误处理和日志记录，代码冗长
4. **话题创建和刷新流程复杂**：涉及多层调用和事件通知

## 优化目标

1. 简化事件处理机制，采用统一的事件系统
2. 减少状态冗余，主要依赖Redux进行状态管理
3. 精简DexieStorageService，只保留核心功能
4. 简化话题创建和刷新流程

## 实施方案

### 阶段一：引入统一的事件系统

参考电脑版的Emittery实现，创建统一的事件系统。

#### 修改文件

1. **新增文件：`src/shared/services/EventService.ts`**

```typescript
import Emittery from 'emittery';

// 创建全局事件发射器
export const EventEmitter = new Emittery();

// 定义事件名称常量
export const EVENT_NAMES = {
  SEND_MESSAGE: 'SEND_MESSAGE',
  MESSAGE_COMPLETE: 'MESSAGE_COMPLETE',
  CLEAR_MESSAGES: 'CLEAR_MESSAGES',
  ADD_NEW_TOPIC: 'ADD_NEW_TOPIC',
  TOPIC_CREATED: 'TOPIC_CREATED',
  SHOW_TOPIC_SIDEBAR: 'SHOW_TOPIC_SIDEBAR',
  FORCE_TOPIC_LIST_UPDATE: 'FORCE_TOPIC_LIST_UPDATE',
  FORCE_MESSAGES_UPDATE: 'FORCE_MESSAGES_UPDATE'
};
```

2. **修改文件：`src/shared/services/index.ts`**

```typescript
// 添加EventService导出
export { EventEmitter, EVENT_NAMES } from './EventService';
```

### 阶段二：精简DexieStorageService

#### 修改文件

1. **修改文件：`src/shared/services/DexieStorageService.ts`**

精简该文件，移除冗余的错误处理、日志记录和事件发布系统，只保留核心功能：

- 保留数据库表定义和初始化
- 保留基本的CRUD操作
- 保留单例模式
- 移除复杂的事件发布/订阅系统
- 移除冗余的错误处理和日志记录
- 移除迁移相关代码（如果已完成迁移）
- 移除诊断和状态检查功能

### 阶段三：优化话题创建流程

#### 修改文件

1. **修改文件：`src/shared/services/TopicService.ts`**

```typescript
import { v4 as uuid } from 'uuid';
import { store } from '../store';
import { createTopic } from '../store/slices/messagesSlice';
import type { ChatTopic } from '../types';
import { formatDateForTopicTitle } from '../utils';
import { DEFAULT_TOPIC_PROMPT } from '../config/constants';
import { dexieStorage } from './DexieStorageService';
import { AssistantService } from './assistant';
import { EventEmitter, EVENT_NAMES } from './EventService';

export class TopicService {
  /**
   * 创建新话题并关联到当前助手
   */
  static async createNewTopic(): Promise<ChatTopic | null> {
    try {
      // 获取当前助手ID
      const currentAssistantId = await this.getCurrentAssistantId();
      if (!currentAssistantId) {
        console.error('无法创建话题，未找到当前助手ID');
        return null;
      }

      // 创建话题对象
      const topicId = uuid();
      const now = new Date();
      const formattedDate = formatDateForTopicTitle(now);
      const newTopic: ChatTopic = {
        id: topicId,
        title: `新的对话 ${formattedDate}`,
        lastMessageTime: now.toISOString(),
        assistantId: currentAssistantId,
        prompt: DEFAULT_TOPIC_PROMPT,
        messages: []
      };

      // 保存到数据库
      await dexieStorage.saveTopic(newTopic);

      // 添加到Redux
      store.dispatch(createTopic(newTopic));

      // 关联话题到助手
      await AssistantService.addTopicToAssistant(currentAssistantId, topicId);

      // 发送事件通知
      EventEmitter.emit(EVENT_NAMES.TOPIC_CREATED, {
        topic: newTopic,
        assistantId: currentAssistantId
      });

      return newTopic;
    } catch (error) {
      console.error('创建话题失败:', error);
      return null;
    }
  }

  // 其他方法...
}
```

2. **修改文件：`src/components/toolbar/buttons/NewTopicButtonV2.tsx`**

```typescript
import React from 'react';
import AddIcon from '@mui/icons-material/Add';
import { TopicService } from '../../../shared/services/TopicService';
import { EventEmitter, EVENT_NAMES } from '../../../shared/services/EventService';
import type { ToolbarButtonProps } from './types';
import ToolbarButton from './ToolbarButton';

const NewTopicButtonV2: React.FC<ToolbarButtonProps> = ({
  displayStyle,
  isDarkMode
}) => {
  const handleCreateTopic = async () => {
    // 触发新建话题事件
    EventEmitter.emit(EVENT_NAMES.ADD_NEW_TOPIC);

    // 创建新话题
    await TopicService.createNewTopic();
  };

  return (
    <ToolbarButton
      displayStyle={displayStyle}
      isDarkMode={isDarkMode}
      icon={<AddIcon sx={{ fontSize: '18px' }} />}
      label="新建话题"
      onClick={handleCreateTopic}
      color={isDarkMode ? '#FFFFFF' : '#4CAF50'}
      iconColor={isDarkMode ? '#9E9E9E' : '#4CAF50'}
    />
  );
};

export default NewTopicButtonV2;
```

### 阶段四：优化话题列表刷新机制

#### 修改文件

1. **修改文件：`src/components/TopicManagement/SidebarTabs.tsx`**

```typescript
// 在组件内部添加事件监听
useEffect(() => {
  // 监听话题创建事件
  const handleTopicCreated = async (data: any) => {
    const { topic, assistantId } = data;

    // 如果创建的话题属于当前助手，则更新话题列表
    if (currentAssistant && currentAssistant.id === assistantId) {
      refreshCurrentAssistantTopics();
    }
  };

  // 监听强制更新话题列表事件
  const handleForceTopicListUpdate = () => {
    refreshCurrentAssistantTopics();
  };

  // 注册事件监听
  const unsubscribeTopicCreated = EventEmitter.on(
    EVENT_NAMES.TOPIC_CREATED,
    handleTopicCreated
  );

  const unsubscribeForceUpdate = EventEmitter.on(
    EVENT_NAMES.FORCE_TOPIC_LIST_UPDATE,
    handleForceTopicListUpdate
  );

  // 清理函数
  return () => {
    unsubscribeTopicCreated();
    unsubscribeForceUpdate();
  };
}, [currentAssistant, refreshCurrentAssistantTopics]);
```

2. **修改文件：`src/shared/store/index.ts`**

```typescript
import { EventEmitter, EVENT_NAMES } from '../services/EventService';

// 自定义中间件
const customMiddleware = (store: any) => (next: any) => (action: any) => {
  // 检查特定的action类型
  if (action.type === 'FORCE_TOPICS_UPDATE') {
    // 调度标准的Redux Toolkit action
    store.dispatch(forceTopicsUpdate());

    // 触发事件
    EventEmitter.emit(EVENT_NAMES.FORCE_TOPIC_LIST_UPDATE);

    return;
  } else if (action.type === 'messages/createTopic') {
    // 先让原始action执行
    const result = next(action);

    // 然后触发话题列表更新
    setTimeout(() => {
      store.dispatch({ type: 'FORCE_TOPICS_UPDATE' });
    }, 200);

    return result;
  }

  return next(action);
};
```

### 阶段五：优化消息列表刷新机制

#### 修改文件

1. **修改文件：`src/components/MessageList.tsx`**

```typescript
import { EventEmitter, EVENT_NAMES } from '../shared/services/EventService';

// 在组件内部添加事件监听
useEffect(() => {
  // 处理话题清空事件
  const handleTopicCleared = () => {
    setForceRender(prev => prev + 1);
  };

  // 处理强制更新事件
  const handleForceUpdate = () => {
    setForceRender(prev => prev + 1);
  };

  // 注册事件监听
  const unsubscribeTopicCleared = EventEmitter.on(
    EVENT_NAMES.CLEAR_MESSAGES,
    handleTopicCleared
  );

  const unsubscribeForceUpdate = EventEmitter.on(
    EVENT_NAMES.FORCE_MESSAGES_UPDATE,
    handleForceUpdate
  );

  // 清理函数
  return () => {
    unsubscribeTopicCleared();
    unsubscribeForceUpdate();
  };
}, []);
```

2. **修改文件：`src/shared/services/TopicService.ts`** (添加清空话题方法)

```typescript
/**
 * 清空当前话题内容
 */
static async clearTopicContent(topicId: string): Promise<boolean> {
  if (!topicId) return false;

  try {
    // 派发清空消息的action
    store.dispatch({
      type: 'messages/setTopicMessages',
      payload: {
        topicId,
        messages: []
      }
    });

    // 发送事件通知
    EventEmitter.emit(EVENT_NAMES.CLEAR_MESSAGES, { topicId });

    return true;
  } catch (error) {
    console.error('清空话题内容失败', error);
    return false;
  }
}
```

## 实施步骤

1. 安装Emittery库：`npm install emittery`
2. 按照阶段一到阶段五的顺序实施修改
3. 每个阶段完成后进行测试，确保功能正常
4. 完成所有修改后进行全面测试

## 预期效果

1. 代码结构更清晰，逻辑更集中
2. 事件处理更统一，使用Emittery替代自定义DOM事件
3. DexieStorageService更精简，只保留核心功能
4. 话题创建和刷新流程更简单，与电脑版实现更接近
5. 性能提升，减少不必要的状态更新和事件触发

## 需要清理的旧代码

在实施新方案的过程中，需要清理以下旧代码：

### 1. 自定义DOM事件相关代码

1. **`src/components/TopicManagement/SidebarTabs.tsx`**:
   - 移除 `window.addEventListener('topicCreated', ...)` 和 `window.removeEventListener('topicCreated', ...)` 相关代码
   - 移除 `window.addEventListener('forceTopicListUpdate', ...)` 和 `window.removeEventListener('forceTopicListUpdate', ...)` 相关代码
   - 移除 `setTopicListUpdateFlag` 状态和相关更新逻辑

2. **`src/components/MessageList.tsx`**:
   - 移除 `window.addEventListener('topicCleared', ...)` 和 `window.removeEventListener('topicCleared', ...)` 相关代码
   - 移除 `window.addEventListener('FORCE_MESSAGES_UPDATE', ...)` 和 `window.removeEventListener('FORCE_MESSAGES_UPDATE', ...)` 相关代码

3. **`src/shared/services/TopicService.ts`**:
   - 移除 `notifyTopicCreated` 方法中的 `window.dispatchEvent(new CustomEvent('topicCreated', ...))` 代码
   - 移除其他使用 `window.dispatchEvent` 的自定义事件代码

### 2. DexieStorageService中的冗余代码

1. **`src/shared/services/DexieStorageService.ts`**:
   - 移除 `eventTarget` 和 `EVENT_TYPES` 相关代码
   - 移除 `subscribe` 和 `publish` 方法
   - 移除冗余的错误处理和日志记录代码
   - 移除 `migrateFromLegacyDB` 方法及相关代码
   - 移除 `getDatabaseStatus`, `isDatabaseInitialized` 等诊断方法
   - 移除 `_ensureDatabaseStructure`, `_ensureDatabaseInitialized` 等复杂初始化方法
   - 移除 `exportData`, `importData` 等备份相关方法
   - 简化 `cleanObject` 等辅助方法

### 3. Redux相关冗余代码

1. **`src/shared/store/slices/messagesSlice.ts`**:
   - 简化 `forceTopicsUpdate` action，移除冗余的日志记录
   - 简化 `createTopic` action中的冗余逻辑

2. **`src/shared/store/index.ts`**:
   - 重构 `customMiddleware`，使用新的事件系统替代自定义DOM事件

### 4. 组件内部状态管理冗余代码

1. **`src/components/TopicManagement/SidebarTabs.tsx`**:
   - 移除 `topicListUpdateFlag` 状态和相关更新逻辑
   - 简化 `refreshCurrentAssistantTopics` 方法，移除冗余的日志记录
   - 移除重复的本地状态更新代码

2. **`src/pages/ChatPage/hooks/useTopicManagement.ts`**:
   - 简化话题创建和管理逻辑，使用新的事件系统

## 注意事项

1. 修改过程中需要保持功能的完整性，确保所有现有功能正常工作
2. 需要全面测试各种场景，特别是话题创建、切换和消息加载
3. 可能需要调整其他相关组件以适应新的事件系统
4. 建议分阶段实施，每个阶段完成后进行测试
5. 清理旧代码时要谨慎，确保不会破坏现有功能
